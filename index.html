<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HerabChat</title>
  <style>
    :root{
      --bg1:#89f7fe; --bg2:#66a6ff;
      --panel:#ffffff; --panel-dark:#222;
      --primary:#007bff; --muted:#e0e0e0;
      --danger:#dc3545; --success:#28a745; --text:#000;
    }
    body{
      font-family: system-ui, Arial, sans-serif;
      height:100vh;margin:0;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      transition:background .3s,color .3s;
    }
    body.dark{ background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#fff; }
    .chat{
      width:380px;height:620px;background:var(--panel); border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); display:flex;flex-direction:column;overflow:hidden;
    }
    body.dark .chat{ background:var(--panel-dark); }
    .top{
      background:var(--primary); color:#fff; padding:12px 14px; display:flex; align-items:center; justify-content:space-between;
      font-weight:700;
    }
    .top .actions{display:flex;gap:8px}
    .top button{
      border:none;border-radius:8px;padding:6px 10px;cursor:pointer;color:#fff
    }
    .mode{background:var(--success)}
    .clear{background:var(--danger)}
    .tts{background:#6f42c1}
    .box{flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;}
    .row{display:flex; gap:8px; align-items:flex-end; max-width:85%}
    .row.user{ margin-left:auto; flex-direction:row-reverse; }
    .avatar{
      width:34px;height:34px;border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-size:18px; background:#ffd166
    }
    .row.user .avatar{ background:#74c0fc }
    .bubble{
      padding:10px 12px;border-radius:14px; line-height:1.3; word-wrap:break-word; position:relative
    }
    .row.bot .bubble{ background:var(--muted); color:#000 }
    .row.user .bubble{ background:var(--primary); color:#fff }
    .meta{font-size:10px; opacity:.7; margin-top:2px}
    .reactions{font-size:14px; margin-top:4px; user-select:none}
    .reactions span{cursor:pointer; margin-right:6px}
    .input{
      border-top:1px solid #0001; display:flex; gap:6px; padding:8px; background:#f4f4f4
    }
    body.dark .input{ background:#333 }
    .input input{
      flex:1;border:none;outline:none;padding:10px;border-radius:10px
    }
    .send,.mic{
      border:none; padding:10px 12px; border-radius:10px; cursor:pointer; color:#fff; background:var(--primary)
    }
    .mic{ background:#ff7a59 }
    .typing{
      align-self:flex-start; display:flex; gap:8px; align-items:center
    }
    .dots{display:inline-block; min-width:28px}
    .dots span{display:inline-block;width:6px;height:6px;border-radius:50%; background:#999;margin-right:4px; animation:blink 1s infinite}
    .dots span:nth-child(2){animation-delay:.2s}
    .dots span:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
    .notice{font-size:11px; opacity:.8; text-align:center; padding:6px}
  </style>
</head>
<body>
  <div class="chat">
    <div class="top">
      <div>HerabChat üí¨</div>
      <div class="actions">
        <button class="tts" id="ttsBtn" title="Toggle bot voice">üîä Voice: Off</button>
        <button class="mode" id="modeBtn" title="Dark / Light">üåô</button>
        <button class="clear" id="clearBtn" title="Clear chat">üßπ</button>
      </div>
    </div>

    <div id="box" class="box"></div>

    <div class="input">
      <button class="mic" id="micBtn" title="Hold to speak">üé§</button>
      <input id="inp" type="text" placeholder="Type a message‚Ä¶"/>
      <button class="send" id="sendBtn">Send</button>
    </div>
    <div class="notice">AI answers powered by a secure API (no key in the browser).</div>
  </div>

  <script>
    // Elements
    const box = document.getElementById('box');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const modeBtn = document.getElementById('modeBtn');
    const micBtn  = document.getElementById('micBtn');
    const ttsBtn  = document.getElementById('ttsBtn');

    // Settings
    let speakBot = false; // toggled by ttsBtn

    // Load history + welcome
    window.addEventListener('load', () => {
      const hist = JSON.parse(localStorage.getItem('herab_history') || '[]');
      hist.forEach(m => addMessage(m.text, m.sender, m.time, false));
      botReply("Hello üëã, I‚Äôm HerabChat. How can I help you?");
    });

    // Helpers
    function nowTime(){
      return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function saveMessage(text, sender){
      const hist = JSON.parse(localStorage.getItem('herab_history') || '[]');
      hist.push({text, sender, time: nowTime()});
      localStorage.setItem('herab_history', JSON.stringify(hist));
    }

    function addMessage(text, sender='bot', time=nowTime(), save=true){
      const row = document.createElement('div');
      row.className = `row ${sender}`;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = sender === 'bot' ? 'ü§ñ' : 'üßë';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = time;

      const reactions = document.createElement('div');
      reactions.className = 'reactions';
      reactions.innerHTML = '<span>üòÇ</span><span>‚ù§Ô∏è</span><span>üëç</span>';
      reactions.addEventListener('click', (e)=>{
        if(e.target.tagName === 'SPAN'){
          alert(`You reacted with ${e.target.textContent}`);
        }
      });

      row.appendChild(avatar);
      const wrap = document.createElement('div');
      wrap.style.display='flex'; wrap.style.flexDirection='column';
      wrap.appendChild(bubble); wrap.appendChild(meta); wrap.appendChild(reactions);
      row.appendChild(wrap);

      box.appendChild(row);
      box.scrollTop = box.scrollHeight;

      if(save) saveMessage(text, sender);
    }

    function typingOn(){
      const t = document.createElement('div');
      t.className = 'typing row bot';
      t.innerHTML = '<div class="avatar">ü§ñ</div><div class="bubble"><span>HerabChat is typing </span><span class="dots"><span></span><span></span><span></span></span></div>';
      box.appendChild(t);
      box.scrollTop = box.scrollHeight;
      return t;
    }
    function typingOff(el){ if(el && el.parentNode) el.parentNode.removeChild(el); }

    function speak(text){
      try{
        if(!('speechSynthesis' in window)) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1; utter.pitch = 1; utter.lang = 'en-US';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      }catch(e){}
    }

    function botReply(text){
      addMessage(text, 'bot');
      if(speakBot) speak(text);
    }

    // SMART reply via your API
    async function botSmartReply(userText){
      const controller = new AbortController();
      const t = typingOn();
      try{
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ message: userText }),
          signal: controller.signal
        });
        const data = await res.json();
        typingOff(t);
        if(data.error){
          botReply("‚ö†Ô∏è Error: " + data.error);
        } else {
          botReply(data.reply);
        }
      } catch (err){
        typingOff(t);
        botReply("‚ö†Ô∏è Network error. Please try again.");
      }
    }

    // Send message
    function send(){
      const val = inp.value.trim();
      if(!val) return;
      addMessage(val, 'user');
      inp.value = '';
      // Ask smart API (empathy/teacher/guide/homework built-in)
      botSmartReply(val);
    }

    sendBtn.addEventListener('click', send);
    inp.addEventListener('keydown', e => { if(e.key === 'Enter') send(); });

    // Controls
    clearBtn.addEventListener('click', ()=>{
      localStorage.removeItem('herab_history');
      box.innerHTML = '';
      botReply('Chat cleared ‚úÖ');
    });

    modeBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
    });

    ttsBtn.addEventListener('click', ()=>{
      speakBot = !speakBot;
      ttsBtn.textContent = speakBot ? 'üîä Voice: On' : 'üîä Voice: Off';
      if(speakBot) botReply("Bot voice enabled üîä");
    });

    // Voice input (Speech-to-Text)
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    if(Recognition){
      rec = new Recognition();
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      rec.addEventListener('result', (e)=>{
        const text = e.results[0][0].transcript;
        inp.value = text;
        send();
      });
      rec.addEventListener('error', ()=> {
        alert('Mic error or permission denied.');
      });
    } else {
      micBtn.disabled = true;
      micBtn.title = "Speech not supported in this browser";
    }

    // Press & hold mic to talk (or click to toggle)
    micBtn.addEventListener('mousedown', ()=>{ if(rec){ micBtn.textContent='üéôÔ∏è Listening...'; try{rec.start()}catch(_){}} });
    micBtn.addEventListener('mouseup',   ()=>{ if(rec){ micBtn.textContent='üé§';                try{rec.stop()}catch(_){}} });
    micBtn.addEventListener('click',     ()=>{
      if(!rec) return;
      if(micBtn.textContent.includes('Listening')){
        micBtn.textContent = 'üé§'; try{rec.stop()}catch(_){}
      } else {
        micBtn.textContent = 'üéôÔ∏è Listening...'; try{rec.start()}catch(_){}
      }
    });
  </script>
</body>
</html>
